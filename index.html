<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>So s√°nh K·∫ø ho·∫°ch & K·∫øt qu·∫£ - 2 File</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .btn-action { @apply flex-1 px-4 py-3 rounded-xl font-bold text-sm transition-all shadow-sm flex items-center justify-center gap-2; }
        .status-pill { @apply px-2 py-0.5 rounded text-[10px] font-bold uppercase; }
    </style>
</head>
<body class="p-4 md:p-8 text-slate-700">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-200 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-slate-900">ƒê·ªëi so√°t K·∫ø ho·∫°ch & K·∫øt qu·∫£</h1>
                <p class="text-slate-500">T·ª± ƒë·ªông kh·ªõp d·ªØ li·ªáu t·ª´ hai file Excel ri√™ng bi·ªát</p>
            </div>
            <button onclick="location.reload()" class="text-slate-400 hover:text-red-500 text-xs font-bold uppercase tracking-widest">L√†m m·ªõi trang</button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-dashed border-blue-300 flex flex-col items-center">
                <span class="text-blue-500 mb-2">üìÅ B∆∞·ªõc 1</span>
                <input type="file" id="planFile" class="hidden" accept=".xlsx, .xls" onchange="readExcel(this, 'plan')">
                <button onclick="document.getElementById('planFile').click()" class="btn-action bg-blue-600 text-white hover:bg-blue-700 w-full">
                    NH·∫¨P FILE K·∫æ HO·∫†CH
                </button>
                <div id="planStatus" class="mt-2 text-xs text-slate-400 italic font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu k·∫ø ho·∫°ch</div>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-dashed border-emerald-300 flex flex-col items-center">
                <span class="text-emerald-500 mb-2">üìÅ B∆∞·ªõc 2</span>
                <input type="file" id="resultFile" class="hidden" accept=".xlsx, .xls" onchange="readExcel(this, 'result')">
                <button onclick="document.getElementById('resultFile').click()" class="btn-action bg-emerald-600 text-white hover:bg-emerald-700 w-full">
                    NH·∫¨P FILE K·∫æT QU·∫¢
                </button>
                <div id="resultStatus" class="mt-2 text-xs text-slate-400 italic font-medium">Ch∆∞a c√≥ d·ªØ li·ªáu k·∫øt qu·∫£</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-12">
                <div class="bg-white p-6 rounded-2xl shadow-sm h-[400px]">
                    <h2 class="font-bold text-slate-800 mb-4 uppercase text-sm tracking-widest">So s√°nh Trung b√¨nh c·ªông to√†n kh·ªëi</h2>
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <div class="lg:col-span-12">
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="p-4 text-xs font-bold text-slate-400 uppercase">L·ªõp</th>
                                <th class="text-center text-xs font-bold text-slate-400 uppercase">T·ªët (KH/KQ)</th>
                                <th class="text-center text-xs font-bold text-slate-400 uppercase">Kh√° (KH/KQ)</th>
                                <th class="text-center text-xs font-bold text-slate-400 uppercase">ƒê·∫°t (KH/KQ)</th>
                                <th class="text-center text-xs font-bold text-red-400 uppercase">Ch∆∞a ƒë·∫°t (KH/KQ)</th>
                                <th class="text-right p-4 text-xs font-bold text-slate-400 uppercase">ƒê√°nh gi√°</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-50">
                            <tr><td colspan="6" class="p-8 text-center text-slate-400 italic">Vui l√≤ng nh·∫≠p c·∫£ 2 file ƒë·ªÉ b·∫Øt ƒë·∫ßu so s√°nh...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db = {}; // C·∫•u tr√∫c: { "10A1": { p: [0,0,0,0], r: [0,0,0,0] } }
        let chartInstance;

        function readExcel(input, type) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(sheet, {header: 1});

                rows.forEach((row, index) => {
                    if (index === 0 || !row[0]) return; // B·ªè qua ti√™u ƒë·ªÅ
                    const className = String(row[0]).trim();
                    if (!db[className]) db[className] = { p: [0,0,0,0], r: [0,0,0,0] };
                    
                    const values = [row[1]||0, row[2]||0, row[3]||0, row[4]||0];
                    if (type === 'plan') db[className].p = values;
                    else db[className].r = values;
                });

                document.getElementById(`${type}Status`).innerText = `ƒê√£ t·∫£i ${Object.keys(db).length} l·ªõp`;
                document.getElementById(`${type}Status`).className = "mt-2 text-xs text-blue-600 font-bold italic";
                updateUI();
            };
            reader.readAsArrayBuffer(file);
        }

        function getStatus(plan, res, isCDat) {
            const isOk = isCDat ? (res <= plan) : (res >= plan);
            return isOk ? 
                '<span class="status-pill bg-green-100 text-green-600">ƒê·∫°t</span>' : 
                '<span class="status-pill bg-red-100 text-red-600">K.ƒê·∫°t</span>';
        }

        function updateUI() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            let sumP = [0,0,0,0], sumR = [0,0,0,0];
            const classes = Object.keys(db);

            classes.forEach(cls => {
                const item = db[cls];
                item.p.forEach((v, i) => sumP[i] += v);
                item.r.forEach((v, i) => sumR[i] += v);

                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4 font-bold text-slate-700">${cls}</td>
                        <td class="text-center text-sm">${item.p[0]} / ${item.r[0]}</td>
                        <td class="text-center text-sm">${item.p[1]} / ${item.r[1]}</td>
                        <td class="text-center text-sm">${item.p[2]} / ${item.r[2]}</td>
                        <td class="text-center text-sm font-medium ${item.r[3] > item.p[3] ? 'text-red-500' : ''}">${item.p[3]} / ${item.r[3]}</td>
                        <td class="text-right p-4">${getStatus(item.p[0], item.r[0], false)} ${getStatus(item.p[3], item.r[3], true)}</td>
                    </tr>`;
            });

            if(classes.length > 0) {
                const avgP = sumP.map(v => (v / classes.length).toFixed(1));
                const avgR = sumR.map(v => (v / classes.length).toFixed(1));
                renderChart(avgP, avgR);
            }
        }

        function renderChart(pData, rData) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['T·ªët', 'Kh√°', 'ƒê·∫°t', 'Ch∆∞a ƒë·∫°t'],
                    datasets: [
                        { label: 'TB K·∫ø ho·∫°ch', data: pData, backgroundColor: '#cbd5e1', borderRadius: 6 },
                        { label: 'TB K·∫øt qu·∫£', data: rData, backgroundColor: '#2563eb', borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });
        }
    </script>
</body>
</html>
